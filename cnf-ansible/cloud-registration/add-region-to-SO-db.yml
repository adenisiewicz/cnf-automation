- name: Get MariaDB Galera secret
  shell: kubectl get secrets/dev-mariadb-galera-db-root-password --template={{template}} | base64 -d
  become: true
  register: secret

- name: Get info from CLOUD_SITES table from CatalogDB
  shell: kubectl exec dev-mariadb-galera-0 -n onap -- bash -c "mysql -uroot -p{{secret.stdout}} catalogdb -e 'SELECT * FROM cloud_sites;'"
  become: true
  register: cloud_sites

- name: CLOUD_SITES table content
  debug:
    msg: "{{cloud_sites.stdout_lines}}"

- name: Add new region to MadiaDB CLOUD_SITES table
  shell: kubectl exec dev-mariadb-galera-0 -n onap -- bash -c "mysql -uroot -p{{secret.stdout}} catalogdb -e 'insert into cloud_sites(ID, REGION_ID, IDENTITY_SERVICE_ID, CLOUD_VERSION, CLLI, ORCHESTRATOR ) values (\"{{k8s.region_id}}\", \"{{k8s.region_id}}\", \"DEFAULT_KEYSTONE\", \"2.5\", \"{{k8s.complex}}\", \"multicloud\");'"
  become: true
  when: not (cloud_sites.stdout | regex_search(k8s.region_id))
