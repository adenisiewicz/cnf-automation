- name: Check if Tenant exisits
  uri:
    url: https://{{ONAP_k8s_IP}}:30233/aai/v16/cloud-infrastructure/cloud-regions/cloud-region/{{k8s.cloud_owner}}/{{k8s.region_id}}/tenants/tenant/{{k8s.tenant}}
    url_username: "{{ AAI_user }}"
    url_password: "{{ AAI_pass }}"
    force_basic_auth: yes
    headers:
      Accept: "application/json"
      Content-Type: "application/json"
      X-FromAppId: "Ansible"
      X-TransactionId: "get_aai_subscr"
    method: GET
    status_code: 200, 404
    return_content: yes
    validate_certs: False
  register: checkTenant

- name: Prepare create-tenant.json
  copy:
    dest: tmp/create-tenant.json
    content: |
      {
          "tenant-id": "{{k8s.tenant}}",
          "tenant-name": "{{k8s.tenant}}",
          "relationship-list": {
            "relationship": [
              {
                "related-to": "service-subscription",
                "relationship-label": "org.onap.relationships.inventory.Uses",
                "related-link": "/aai/v16/business/customers/customer/{{customer}}/service-subscriptions/service-subscription/{{service_type}}",
                "relationship-data": [
                    {
                        "relationship-key": "customer.global-customer-id",
                        "relationship-value": "{{customer}}"
                    },
                    {
                        "relationship-key": "service-subscription.service-type",
                        "relationship-value": "{{service_type}}"
                    }
                ]
              }
            ]
          }
      }
  when: checkTenant.status == 404

- name: Add Tenant to Region
  uri:
    url: https://{{ONAP_k8s_IP}}:30233/aai/v16/cloud-infrastructure/cloud-regions/cloud-region/{{k8s.cloud_owner}}/{{k8s.region_id}}/tenants/tenant/{{k8s.tenant}}
    url_username: "{{ AAI_user }}"
    url_password: "{{ AAI_pass }}"
    force_basic_auth: yes
    headers:
      Accept: "application/json"
      Content-Type: "application/json"
      X-FromAppId: "Ansible"
      X-TransactionId: "get_aai_subscr"
    method: PUT
    status_code: 201
    return_content: yes
    validate_certs: False
    body_format: json
    body: "{{ lookup('file','tmp/create-tenant.json') }}"
  when: checkTenant.status == 404
