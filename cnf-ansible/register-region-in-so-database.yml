- name: Get info from CLOUD_SITES table from MariaDB Galera 
  shell: kubectl exec dev-mariadb-galera-mariadb-galera-0 -n onap -- bash -c "mysql -uroot -psecretpassword catalogdb -e 'SELECT ID FROM cloud_sites;'"
  register: cloud_sites

- debug:
    msg: This is {{cloud_sites.stdout_lines}}

- name: Prepare script to add new Cloud Region into DB if not present
  copy:
    dest: add_cloud_region.sh
    mode: u=rwx,g=r,o=r
    content: |
      #!/bin/bash
      SAMPLE=`kubectl get pods | grep mariadb-galera-mariadb-galera-0 | awk '{print $1}'`
      kubectl exec $SAMPLE -n onap -- bash -c "mysql -uroot -psecretpassword catalogdb -e 'insert into cloud_sites(ID, REGION_ID, IDENTITY_SERVICE_ID, CLOUD_VERSION, CLLI, ORCHESTRATOR ) values (\"{{cloud_region}}\", \"{{cloud_region}}\", \"DEFAULT_KEYSTONE\", \"2.5\", \"clli1\", \"multicloud\");'"
  when: not (cloud_sites.stdout | regex_search(cloud_region))

- name: Configure SO. Execute add_cloud_region.sh script
  shell: ./add_cloud_region.sh 
  when: not (cloud_sites.stdout | regex_search(cloud_region))

- name: Delete script
  file:
    path: mysqladd.sh
    state: absent
